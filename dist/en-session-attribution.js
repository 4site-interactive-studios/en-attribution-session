(()=>{"use strict";var e,t=new Uint8Array(16);function n(){if(!e&&!(e="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return e(t)}const o=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,r=function(e){return"string"==typeof e&&o.test(e)};for(var s=[],i=0;i<256;++i)s.push((i+256).toString(16).substr(1));const a=function(e,t,o){var i=(e=e||{}).random||(e.rng||n)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){o=o||0;for(var a=0;a<16;++a)t[o+a]=i[a];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase();if(!r(n))throw TypeError("Stringified UUID is invalid");return n}(i)};function c(e,t){const n=`${e}=${t};path=/`;return document.cookie=n,n}function u(e,t=""){const n=document.querySelector("script[src*='attribution.js']");if(n){const o=n.getAttribute("session-"+e);return null!=o?o:t}return t}function l(){const e=[],t=new URL(document.location.href);let n;return window.location!==window.parent.location?n=document.referrer:(n=""===document.referrer?"direct":document.referrer,"direct"!==n&&(n=new URL(n).hostname)),t.searchParams.delete("engrid_session"),e.push(a()),e.push(p()),e.push(p()),e.push("1"),e.push(n),t.search.length>0?e.push(t.search.slice(1)):e.push(""),e.join("|")}function d(e,t=!0){const n=w(e);n.last_seen=p();const o=new URL(document.location.href);let r;return window.location!==window.parent.location?r=document.location.href:(r=""===document.referrer?"direct":document.referrer,"direct"!==r&&(r=new URL(r).hostname)),t&&(n.page_count=(parseInt(n.page_count)+1).toString()),o.searchParams.delete("engrid_session"),n.current_referral=r,n.current_params=o.search.length>0?o.search.slice(1):"",Object.values(n).join("|")}function f(e){let t=window.atob(e);if(e.length>1500&&t.split("|").length>6){const n=w(t);delete n.current_referral,delete n.current_params,t=Object.values(n).join("|"),e=window.btoa(t)}return e.length>1500?"":e}function p(e=!0){return e?Math.round(Date.now()/1e3).toString():Math.round(Date.now()/1e3)}function w(e){const t=e.split("|"),n={};return n.uuid=t[0],n.first_seen=t[1],n.last_seen=t[2],n.page_count=t[3],n.first_referral=t[4],n.first_params=t[5],t[6]&&(n.current_referral=t[6]),t[7]&&(n.current_params=t[7]),n}const m=function(e=!0,t=""){var n,o;const r=window.location.search;let s="",i="",a=new URLSearchParams(r).get("engrid_session");a=a?window.atob(a):"";let m=function(e){const t=document.cookie.split("; "),n=[],o=[];return t.forEach((e=>{const t=e.split("=");n.push(t[0]),o.push(t[1])})),!!n.includes(e)&&o[n.indexOf(e)]}("engrid_attribution_memory_cookie");m=m?window.atob(m):"";const h=u("mem_attribution"),g=document.querySelector(`input[name="${h}"]`);if(i=g?g.value:"",""!==i&&(i=window.atob(i)),""===i&&""===m&&""===a)s="";else{const e=isNaN(parseInt(w(m).last_seen))?0:parseInt(w(m).last_seen),t=isNaN(parseInt(w(i).last_seen))?0:parseInt(w(i).last_seen),o=isNaN(parseInt(w(a).last_seen))?0:parseInt(w(a).last_seen);s=t<=e?m:i,s=(null!==(n=parseInt(w(s).last_seen))&&void 0!==n?n:0)<=o?a:s}const _=u("expiration","3600");let y;const b=w(s);if(y=""===s||p(!1)-parseInt(b.last_seen)>=parseInt(_),"pageJson"in window){s=y?l():d(s,e);let t=window.btoa(s);if(t=f(t),""===t)return;c("engrid_attribution_memory_cookie",t),g&&(g.value=t)}else{s=y?l():d(s,e);let t=window.btoa(s);t=f(t),c("engrid_attribution_memory_cookie",t),document.querySelectorAll("a").forEach((e=>{e.addEventListener("click",(n=>{if(/\/page\/[0-9]{5,6}\//.test(e.href)){n.preventDefault();const o=new URL(e.href);""===t||o.searchParams.set("engrid_session",t),window.location.href=o.href}}))}))}if(function(e){const t=document.querySelector(".currentSession");t&&(t.innerHTML="Current session: "+e);const n=w(e);window.location!==window.parent.location?console.log("[iframe session]",n):console.log("[page session]",n)}(s),window.location===window.parent.location){const e=document.querySelectorAll("iframe");for(let t=0;t<e.length;++t)/\/page\/[0-9]{5,6}\//.test(e[t].src)&&(null===(o=e[t].contentWindow)||void 0===o||o.postMessage(s,"*"))}};window.addEventListener("load",(()=>{m()})),window.addEventListener("visibilitychange",(()=>{window.location===window.parent.location&&"visible"===document.visibilityState&&m(!1)}))})();