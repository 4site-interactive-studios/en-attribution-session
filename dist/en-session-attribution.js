(()=>{"use strict";var e,t=new Uint8Array(16);function n(){if(!e&&!(e="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return e(t)}const o=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,r=function(e){return"string"==typeof e&&o.test(e)};for(var i=[],s=0;s<256;++s)i.push((s+256).toString(16).substr(1));const a=function(e,t,o){var s=(e=e||{}).random||(e.rng||n)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){o=o||0;for(var a=0;a<16;++a)t[o+a]=s[a];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase();if(!r(n))throw TypeError("Stringified UUID is invalid");return n}(s)};function c(e,t){const n=`${e}=${t};path=/`;return document.cookie=n,n}function u(e,t=""){const n=document.querySelector("script[src*='attribution.js']");if(n){const o=n.getAttribute("session-"+e);return null!=o?o:t}return t}function d(){const e=[],t=new URL(document.location.href);let n;return window.location!==window.parent.location?n=document.referrer:(n=""===document.referrer?"direct":document.referrer,"direct"!==n&&(n=new URL(n).hostname)),t.searchParams.delete("engrid_session"),e.push(a()),e.push(p()),e.push(p()),e.push("1"),e.push(n),t.search.length>0?e.push(t.search.slice(1)):e.push(""),e.join("|")}function l(e,t=!0){const n=f(e);n.last_seen=p();const o=new URL(document.location.href);let r;return window.location!==window.parent.location?r=document.location.href:(r=""===document.referrer?"direct":document.referrer,"direct"!==r&&(r=new URL(r).hostname)),t&&(n.page_count=(parseInt(n.page_count)+1).toString()),o.searchParams.delete("engrid_session"),n.current_referral=r,n.current_params=o.search.length>0?o.search.slice(1):"",Object.values(n).join("|")}function w(e){let t=window.atob(e);if(e.length>1500&&t.split("|").length>6){const n=f(t);delete n.current_referral,delete n.current_params,t=Object.values(n).join("|"),e=window.btoa(t)}return e.length>1500?"":e}function p(e=!0){return e?Math.round(Date.now()/1e3).toString():Math.round(Date.now()/1e3)}function f(e){const t=e.split("|"),n={};return n.uuid=t[0],n.first_seen=t[1],n.last_seen=t[2],n.page_count=t[3],n.first_referral=t[4],n.first_params=t[5],t[6]&&(n.current_referral=t[6]),t[7]&&(n.current_params=t[7]),n}function m(e=!0,t=""){var n,o;const r=window.location.search,i=new URLSearchParams(r);let s="",a="",m=i.get("engrid_session");m=m?window.atob(m):"";let h=function(e){const t=document.cookie.split("; "),n=[],o=[];return t.forEach((e=>{const t=e.split("=");n.push(t[0]),o.push(t[1])})),!!n.includes(e)&&o[n.indexOf(e)]}("engrid_attribution_memory_cookie");h=h?window.atob(h):"";const g=u("mem_attribution"),_=document.querySelector(`input[name="${g}"]`);if(a=_?_.value:"",""!==a&&(a=window.atob(a)),""===a&&""===h&&""===m)s="";else{const e=isNaN(parseInt(f(h).last_seen))?0:parseInt(f(h).last_seen),t=isNaN(parseInt(f(a).last_seen))?0:parseInt(f(a).last_seen),o=isNaN(parseInt(f(m).last_seen))?0:parseInt(f(m).last_seen);s=t<=e?h:a;const r=null!==(n=parseInt(f(s).last_seen))&&void 0!==n?n:0;s=r<=o?m:s}""!==t&&(s=t);const v=u("expiration","3600");let y;const b=f(s);if(y=""===s||p(!1)-parseInt(b.last_seen)>=parseInt(v),"pageJson"in window){s=y?d():l(s,e);let t=window.btoa(s);if(t=w(t),""===t)return;if(c("engrid_attribution_memory_cookie",t),_&&(_.value=t),!document.querySelector("[name='transaction.comments'")){const e=document.createElement("input");e.classList.add("en__field__input"),e.classList.add("en__field__input--hidden"),e.setAttribute("type","hidden"),e.setAttribute("name","transaction.comments");const t=JSON.stringify(f(s));e.value=t,null===(o=document.querySelector("body"))||void 0===o||o.appendChild(e)}}else{s=y?d():l(s,e);let t=window.btoa(s);t=w(t),c("engrid_attribution_memory_cookie",t),document.querySelectorAll("a").forEach((e=>{e.addEventListener("click",(n=>{if(/\/page\/[0-9]{5,6}\//.test(e.href)){n.preventDefault();const o=new URL(e.href);""===t||o.searchParams.set("engrid_session",t),window.location.href=o.href}}))}))}if(function(e){const t=document.querySelector(".currentSession");t&&(t.innerHTML="Current session: "+e);const n=f(e);window.location!==window.parent.location?console.log("[iframe session]",n):console.log("[page session]",n)}(s),window.location===window.parent.location&&document.querySelector("iframe")){focus();const e=function(){var t,n;document.activeElement===document.querySelector("iframe")&&/\/page\/[0-9]{5,6}\//.test(null===(t=document.activeElement)||void 0===t?void 0:t.getAttribute("src"))&&(null===(n=document.querySelector("iframe").contentWindow)||void 0===n||n.postMessage(s,"*")),window.removeEventListener("blur",e)};window.addEventListener("blur",e)}return s}let h,g;window.addEventListener("load",(()=>{window.location===window.parent.location?(g=m(),h=setInterval((()=>{g=m(!1)}),6e4)):window.parent.postMessage("Mirror session","*")})),window.addEventListener("visibilitychange",(()=>{if(window.location===window.parent.location&&"visible"===document.visibilityState){const e=!1;m(e),h=setInterval((()=>{m(e)}),6e4)}else clearInterval(h)})),window.addEventListener("message",(function(e){var t,n;window.location!==window.parent.location&&"Mirror session"!==e.data?m(!1,e.data):window.location===window.parent.location&&g&&"Mirror session"===e.data&&(null===(n=null===(t=this.document.querySelector("iframe"))||void 0===t?void 0:t.contentWindow)||void 0===n||n.postMessage(g,"*"))})),document.addEventListener("click",(()=>{window.location!==window.parent.location&&window.parent.postMessage("Mirror session","*")}))})();